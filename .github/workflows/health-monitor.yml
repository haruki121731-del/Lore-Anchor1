name: üîç Health Monitor & Auto-Heal

on:
  schedule:
    # 30ÂàÜ„Åî„Å® (UTC)
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Service Health Check
    runs-on: ubuntu-latest
    outputs:
      api_ok: ${{ steps.api.outputs.ok }}
      waitlist_ok: ${{ steps.waitlist.outputs.ok }}
      issues_found: ${{ steps.summary.outputs.issues }}
    steps:
      - name: Check Railway API
        id: api
        run: |
          STATUS=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" \
            https://api-production-550c.up.railway.app/health)
          echo "HTTP status: $STATUS"
          if [ "$STATUS" = "200" ]; then
            echo "ok=true" >> $GITHUB_OUTPUT
            echo "‚úÖ API healthy"
          else
            echo "ok=false" >> $GITHUB_OUTPUT
            echo "‚ùå API down (HTTP $STATUS)"
          fi
      
      - name: Check Waitlist site
        id: waitlist
        run: |
          STATUS=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" \
            https://waitinglist-xi-sandy.vercel.app)
          if [ "$STATUS" = "200" ]; then
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "ok=false" >> $GITHUB_OUTPUT
            echo "‚ùå Waitlist site down (HTTP $STATUS)"
          fi
      
      - name: Summarize issues
        id: summary
        run: |
          ISSUES=""
          if [ "${{ steps.api.outputs.ok }}" != "true" ]; then
            ISSUES="API_DOWN"
          fi
          if [ "${{ steps.waitlist.outputs.ok }}" != "true" ]; then
            ISSUES="${ISSUES} WAITLIST_DOWN"
          fi
          echo "issues=${ISSUES}" >> $GITHUB_OUTPUT
          echo "Issues found: ${ISSUES:-none}"
      
      - name: Create GitHub issue on failure
        if: steps.summary.outputs.issues != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issues = '${{ steps.summary.outputs.issues }}';
            const now = new Date().toISOString().slice(0, 16);
            
            // Check if alert issue already open
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo,
              labels: 'alert,auto-health', state: 'open', per_page: 5
            });
            
            if (existing.data.length > 0) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: existing.data[0].number,
                body: `‚è∞ ${now} JST ‚Äî Still failing: ${issues}`
              });
            } else {
              // Create new alert issue
              await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title: `üö® [Alert] Service down: ${issues} ‚Äî ${now}`,
                body: `## Auto-detected failure\n\n**Services down:** ${issues}\n\n**Time:** ${now} UTC\n\n**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n### Quick Fix\n- API down: Check Railway dashboard, redeploy if needed\n- Waitlist down: Check Vercel dashboard\n\n*Auto-generated by health monitor*`,
                labels: ['alert', 'auto-health']
              });
            }
      
      - name: Close resolved alert issues
        if: steps.summary.outputs.issues == ''
        uses: actions/github-script@v7
        with:
          script: |
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo,
              labels: 'alert,auto-health', state: 'open', per_page: 10
            });
            for (const issue of existing.data) {
              await github.rest.issues.update({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: issue.number, state: 'closed'
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚úÖ Auto-resolved: All services healthy again.'
              });
            }
