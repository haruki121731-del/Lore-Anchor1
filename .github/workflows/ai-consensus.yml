name: AI Consensus Builder

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“ã”ã¨ã«ãƒã‚§ãƒƒã‚¯

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  analyze-proposal:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'proposal')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Analyze proposal
        id: analyze
        run: |
          echo "Analyzing proposal #${{ github.event.issue.number }}"
          
          # ææ¡ˆå†…å®¹ã‚’å–å¾—
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # é–¢ä¿‚ãƒãƒ¼ãƒ ã‚’ç‰¹å®š
          TEAMS=$(echo "$ISSUE_BODY" | grep -oP '\[x\] .* Team' | sed 's/- \[x\] //')
          
          echo "teams<<EOF" >> $GITHUB_OUTPUT
          echo "$TEAMS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Request team reviews
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const teams = `${{ steps.analyze.outputs.teams }}`.split('\n').filter(t => t);
            
            // å„ãƒãƒ¼ãƒ ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
            const mentions = teams.map(t => `@lore-anchor/${t.toLowerCase().replace(' ', '-')}`).join(' ');
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `## ğŸ›ï¸ æ„æ€æ±ºå®šãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹\n\nã“ã®ææ¡ˆã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®ãƒãƒ¼ãƒ ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ±‚ã‚ã¾ã™:\n\n${mentions}\n\n**æœŸé™:** 72æ™‚é–“ä»¥å†…\n\n### ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹æ³•\nã“ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„:\n\`\`\`\nTeam: [ãƒãƒ¼ãƒ å]\nVote: [approve / reject / abstain]\nComments: [ã‚³ãƒ¡ãƒ³ãƒˆ]\n\`\`\``
            });
            
            // ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: ['under-review']
            });

  check-consensus:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'under-review')
    
    steps:
      - name: Check votes
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });
            
            // æŠ•ç¥¨ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const votes = {};
            comments.data.forEach(comment => {
              const body = comment.body;
              if (body.includes('Team:') && body.includes('Vote:')) {
                const team = body.match(/Team:\s*(.+)/)?.[1]?.trim();
                const vote = body.match(/Vote:\s*(.+)/)?.[1]?.trim();
                if (team && vote) {
                  votes[team] = vote;
                }
              }
            });
            
            // åˆæ„åˆ¤å®š
            const total = Object.keys(votes).length;
            const approves = Object.values(votes).filter(v => v === 'approve').length;
            const rejects = Object.values(votes).filter(v => v === 'reject').length;
            
            console.log(`Votes: ${approves} approve, ${rejects} reject, ${total - approves - rejects} abstain`);
            
            // 70%ä»¥ä¸Šã®è³›æˆã§æ‰¿èª
            const consensusReached = total > 0 && (approves / total) >= 0.7;
            
            return {
              consensus: consensusReached,
              votes: votes,
              summary: `${approves} approve, ${rejects} reject`
            };
      
      - name: Update issue on consensus
        if: steps.check.outputs.consensus == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            
            // æ‰¿èªã‚³ãƒ¡ãƒ³ãƒˆ
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `## âœ… åˆæ„å½¢æˆå®Œäº†\n\nã“ã®ææ¡ˆã¯**æ‰¿èªã•ã‚Œã¾ã—ãŸ**ã€‚\n\n**æŠ•ç¥¨çµæœ:** ${process.env.VOTE_SUMMARY}\n\næ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:\n1. å®Ÿè£…Issueã®ä½œæˆ\n2. æ‹…å½“ãƒãƒ¼ãƒ ã®ã‚¢ã‚µã‚¤ãƒ³\n3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š`
            });
            
            // ãƒ©ãƒ™ãƒ«æ›´æ–°
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: ['approved']
            });
            
            github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              name: 'under-review'
            });

  auto-improvement:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'improvement') && contains(github.event.issue.labels.*.name, 'auto-approved')
    
    steps:
      - name: Auto-implement improvement
        run: |
          echo "Auto-implementing improvement..."
          # ã“ã“ã«è‡ªå‹•å®Ÿè£…ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
          # ä¾‹: è»½å¾®ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€è¨­å®šå¤‰æ›´ãªã©
