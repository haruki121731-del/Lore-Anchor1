name: Self-Improvement Loop

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥æ·±å¤œ
  workflow_dispatch:

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    outputs:
      metrics: ${{ steps.metrics.outputs.data }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Collect system metrics
        id: metrics
        run: |
          python3 << 'EOF'
          import json
          import os
          
          # ã“ã“ã§å®Ÿéš›ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã‚’è¡Œã†
          # ä¾‹: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ã€ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ãƒˆã€ã‚³ã‚¹ãƒˆãªã©
          
          metrics = {
              "api_response_time_p99": 450,  # ms
              "error_rate": 0.5,  # %
              "test_coverage": 65,  # %
              "deployment_frequency": 5,  # per day
              "open_issues": 12,
              "avg_issue_resolution_time": 48  # hours
          }
          
          print(f"::set-output name=data::{json.dumps(metrics)}")
          EOF

  analyze-opportunities:
    runs-on: ubuntu-latest
    needs: collect-metrics
    outputs:
      opportunities: ${{ steps.analysis.outputs.opportunities }}
    
    steps:
      - name: Analyze improvement opportunities
        id: analysis
        run: |
          METRICS='${{ needs.collect-metrics.outputs.metrics }}'
          
          python3 << EOF
          import json
          
          metrics = json.loads('$METRICS')
          opportunities = []
          
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„
          if metrics.get('api_response_time_p99', 0) > 500:
              opportunities.append({
                  "type": "performance",
                  "priority": "high",
                  "title": "APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ æ”¹å–„",
                  "metric": f"p99: {metrics['api_response_time_p99']}ms",
                  "target": "< 500ms"
              })
          
          # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š
          if metrics.get('test_coverage', 0) < 70:
              opportunities.append({
                  "type": "quality",
                  "priority": "medium",
                  "title": "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š",
                  "metric": f"{metrics['test_coverage']}%",
                  "target": "> 70%"
              })
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤é »åº¦å‘ä¸Š
          if metrics.get('deployment_frequency', 0) < 10:
              opportunities.append({
                  "type": "velocity",
                  "priority": "low",
                  "title": "ãƒ‡ãƒ—ãƒ­ã‚¤é »åº¦å‘ä¸Š",
                  "metric": f"{metrics['deployment_frequency']}/day",
                  "target": "> 10/day"
              })
          
          print(f"::set-output name=opportunities::{json.dumps(opportunities)}")
          EOF

  create-improvement-issues:
    runs-on: ubuntu-latest
    needs: analyze-opportunities
    
    steps:
      - name: Create improvement issues
        uses: actions/github-script@v7
        with:
          script: |
            const opportunities = JSON.parse(`${{ needs.analyze-opportunities.outputs.opportunities }}`);
            
            for (const opp of opportunities) {
              // æ—¢å­˜ã®é¡ä¼¼Issueã‚’ãƒã‚§ãƒƒã‚¯
              const existing = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'improvement',
                state: 'open'
              });
              
              const isDuplicate = existing.data.some(issue => 
                issue.title.includes(opp.title)
              );
              
              if (!isDuplicate && opp.priority === 'high') {
                // é«˜å„ªå…ˆåº¦ã®æ”¹å–„ã®ã¿è‡ªå‹•ä½œæˆ
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[AUTO] ${opp.title}`,
                  body: `## è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸæ”¹å–„æ©Ÿä¼š\n\n**ã‚¿ã‚¤ãƒ—:** ${opp.type}\n**å„ªå…ˆåº¦:** ${opp.priority}\n\n### ç¾åœ¨ã®çŠ¶æ…‹\n${opp.metric}\n\n### ç›®æ¨™\n${opp.target}\n\n---\n*ã“ã®Issueã¯è‡ªå‹•æ”¹å–„ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã¾ã—ãŸ*`,
                  labels: ['improvement', 'auto-detected', opp.priority]
                });
              }
            }

  dependency-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check for dependency updates
        run: |
          # ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯
          echo "Checking dependencies..."
          
          # Pythonä¾å­˜é–¢ä¿‚
          if [ -f "requirements.txt" ]; then
            pip list --outdated || true
          fi
          
          # Node.jsä¾å­˜é–¢ä¿‚
          if [ -f "package.json" ]; then
            npm outdated || true
          fi
      
      - name: Create dependency update issue
        if: github.event.schedule == '0 0 * * 0'  # é€±æ¬¡ã®ã¿
        uses: actions/github-script@v7
        with:
          script: |
            // æœˆæ¬¡ã®ä¾å­˜é–¢ä¿‚æ›´æ–°Issueã‚’ä½œæˆ
            const today = new Date().toISOString().slice(0, 7);
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[MAINTENANCE] Dependency Update - ${today}`,
              body: `## ä¾å­˜é–¢ä¿‚ã®å®šæœŸæ›´æ–°\n\n### å¯¾è±¡\n- Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸\n- Node.jsãƒ‘ãƒƒã‚±ãƒ¼ã‚¸\n- GitHub Actions\n\n### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ\n- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å„ªå…ˆ\n- [ ] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°æ¤œè¨¼\n- [ ] æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤`,
              labels: ['maintenance', 'dependencies']
            });

  weekly-report:
    runs-on: ubuntu-latest
    needs: [collect-metrics, analyze-opportunities]
    
    steps:
      - name: Generate weekly report
        uses: actions/github-script@v7
        with:
          script: |
            const metrics = JSON.parse(`${{ needs.collect-metrics.outputs.metrics }}`);
            const opportunities = JSON.parse(`${{ needs.analyze-opportunities.outputs.opportunities }}`);
            
            const report = `## ğŸ“Š é€±æ¬¡ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆ\n\n### ãƒ¡ãƒˆãƒªã‚¯ã‚¹\n| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å€¤ | ç›®æ¨™ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |\n|-----------|-----|------|-----------|\n| API P99 Latency | ${metrics.api_response_time_p99}ms | < 500ms | ${metrics.api_response_time_p99 < 500 ? 'âœ…' : 'âš ï¸'} |\n| Error Rate | ${metrics.error_rate}% | < 1% | ${metrics.error_rate < 1 ? 'âœ…' : 'âš ï¸'} |\n| Test Coverage | ${metrics.test_coverage}% | > 70% | ${metrics.test_coverage > 70 ? 'âœ…' : 'âš ï¸'} |\n| Deployment Freq | ${metrics.deployment_frequency}/day | > 10/day | ${metrics.deployment_frequency > 10 ? 'âœ…' : 'âš ï¸'} |\n\n### æ”¹å–„æ©Ÿä¼š (${opportunities.length})\n${opportunities.map(o => `- **${o.title}** (${o.priority}): ${o.metric} â†’ ${o.target}`).join('\\n')}\n\n### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n${opportunities.filter(o => o.priority === 'high').map(o => `- [ ] ${o.title}`).join('\\n') || 'ç¾æ™‚ç‚¹ã§ç·Šæ€¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“'}\n\n---\n*Generated by Self-Improvement System*`;
            
            // Weeklyãƒ¬ãƒãƒ¼ãƒˆIssueã‚’ä½œæˆ
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[REPORT] Weekly System Health - ${new Date().toISOString().slice(0, 10)}`,
              body: report,
              labels: ['report', 'weekly']
            });
